name: Build and Release Firmware

on:
  push:
    tags:
      - 'v*-broker'
      - 'v*-mqtt-broker'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.4.1
          target: esp32c3

      - name: Build firmware
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          idf.py build

          # Create releases directory
          mkdir -p releases

          # Get version
          VERSION="${GITHUB_REF_NAME}"

          # Copy binary
          cp build/wican-fw.bin "releases/wican-broker-${VERSION}.bin"

          # Create merged binary with bootloader
          esptool.py --chip esp32c3 merge_bin \
            -o "releases/wican-broker-${VERSION}-merged.bin" \
            --flash_mode dio \
            --flash_freq 80m \
            --flash_size 4MB \
            0x0 build/bootloader/bootloader.bin \
            0x8000 build/partition_table/partition-table.bin \
            0x10000 build/wican-fw.bin || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-binaries
          path: releases/*.bin

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*.bin
          body: |
            ## WiCAN Firmware with MQTT Broker

            This firmware adds a local MQTT broker to WiCAN devices.

            ### Installation

            **Easy Method (esptool):**
            ```bash
            pip install esptool
            esptool.py --chip esp32c3 --port /dev/ttyUSB0 write_flash 0x0 wican-broker-${{ github.ref_name }}-merged.bin
            ```

            **Alternative (separate files):**
            ```bash
            esptool.py --chip esp32c3 --port /dev/ttyUSB0 write_flash 0x0 wican-broker-${{ github.ref_name }}.bin
            ```

            ### After Flashing

            1. Connect to WiCAN WiFi AP
            2. Open browser to http://192.168.80.1
            3. Set `mqtt_broker_en` to `enable`
            4. Set `mqtt_en` to `enable`
            5. Save and reboot
            6. MQTT broker running on `192.168.80.1:1883`

            ### Documentation

            See [MQTT_BROKER_README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/MQTT_BROKER_README.md) for full usage guide.

            ### Changes

            - ‚ú® Added local MQTT broker (Mosquitto)
            - ‚ú® Auto-connect client to local broker when enabled
            - üìù Based on WiCAN firmware commit: $(git log --format="%H" -n 1)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
